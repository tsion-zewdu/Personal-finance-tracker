{% extends 'tracker/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Categories - Personal Finance Tracker{% endblock %}

{% block content %}
<!-- CATEGORIES PAGE -->
<div class="min-h-full p-4 md:p-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Categories & Budgets</h1>
                <p class="text-sm text-slate-600 mt-1">Organize spending and set monthly budgets</p>
            </div>
            <button id="add-category-btn" 
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-500">
                <i class="fas fa-plus mr-2"></i> Add Category
            </button>
        </div>
    </div>
    
    <!-- Budget Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Total Budget</p>
            <p id="cat-total-budget" class="text-2xl font-bold text-slate-900">
                {{ user_profile.currency_symbol }}{{ total_budget|floatformat:2|intcomma }}
            </p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Total Spent</p>
            <p id="cat-total-spent" class="text-2xl font-bold text-red-600">
                {{ user_profile.currency_symbol }}{{ total_spent|floatformat:2|intcomma }}
            </p>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Remaining</p>
            <p id="cat-remaining" class="text-2xl font-bold text-green-600">
                {{ user_profile.currency_symbol }}{{ remaining|floatformat:2|intcomma }}
            </p>
        </div>
    </div>
    
    <!-- Categories List -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Expense Categories -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-900">Expense Categories</h3>
                <span class="text-sm text-slate-500">{{ expense_categories.count }} categories</span>
            </div>
            <div id="categories-list" class="space-y-3">
                {% for category in expense_categories %}
<div class="category-item flex items-center justify-between p-4 border rounded-lg" data-id="{{ category.id }}">
    <div class="flex items-center gap-3 flex-1">
        <span class="text-2xl">{{ category.icon|default:"ðŸ“¦" }}</span>
        <div class="flex-1">
            <p class="text-sm font-medium text-slate-900">{{ category.name }}</p>
            {% if category.monthly_budget > 0 %}
                <p class="text-xs text-slate-600 mt-1">Budget: {{ user_profile.currency_symbol }}{{ category.monthly_budget|floatformat:2|intcomma }}</p>
            {% else %}
                <p class="text-xs text-slate-500 mt-1">No budget set</p>
            {% endif %}
        </div>
    </div>

    {% if not category.is_default %}
    <div class="flex gap-2">
        <button class="edit-category text-blue-600" 
                data-id="{{ category.id }}" 
                data-name="{{ category.name }}" 
                data-type="{{ category.category_type }}" 
                data-icon="{{ category.icon|default:'' }}"
                data-budget="{{ category.monthly_budget|default:0 }}">
            <i class="fas fa-edit"></i>
        </button>
        <button class="delete-category text-red-600"
                data-id="{{ category.id }}" 
                data-name="{{ category.name }}">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    {% endif %}

    {% if category.is_default %}
    <!-- Inline budget edit for default categories -->
    <div class="flex gap-2">
        <input type="number" class="budget-input" value="{{ category.monthly_budget|default:'' }}" placeholder="Set budget">
        <button class="save-budget text-green-600">Save</button>
    </div>
    {% endif %}
</div>
{% endfor %}

            </div>
        </div>
        
        <!-- Income Categories -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-900">Income Categories</h3>
                <span class="text-sm text-slate-500">{{ income_categories.count }} categories</span>
            </div>
            <div id="income-categories-list" class="space-y-3">
                {% for category in income_categories %}
                <div class="category-item flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors" data-id="{{ category.id }}">
                    <div class="flex items-center gap-3 flex-1">
                        <span class="text-2xl">{{ category.icon|default:"ðŸ’°" }}</span>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-900">{{ category.name }}</p>
                            <p class="text-xs text-slate-500 mt-1">Income category</p>
                        </div>
                    </div>
                    {% if not category.is_default %}
                    <div class="flex gap-2">
                        <button class="edit-category text-blue-600 hover:text-blue-800 text-sm font-medium p-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                data-id="{{ category.id }}"
                                data-name="{{ category.name }}"
                                data-type="{{ category.category_type }}"
                                data-icon="{{ category.icon|default:'' }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-category text-red-600 hover:text-red-800 text-sm font-medium p-1 rounded focus:outline-none focus:ring-2 focus:ring-red-500"
                                data-id="{{ category.id }}"
                                data-name="{{ category.name }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <i class="fas fa-money-bill-wave text-3xl text-slate-300 mb-3"></i>
                    <p class="text-sm text-slate-500">No income categories found.</p>
                    <button id="add-income-category-btn" class="mt-3 text-sm text-green-600 hover:text-green-700 font-medium">
                        Add income category
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Edit category functionality
    document.querySelectorAll('.edit-category').forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.dataset.id;
            
            // Populate form with category data
            document.getElementById('category-id').value = categoryId;
            document.getElementById('category-modal-title').textContent = 'Edit Category';
            document.querySelector(`input[name="category-type"][value="${this.dataset.type}"]`).checked = true;
            document.getElementById('category-name').value = this.dataset.name;
            document.getElementById('category-icon').value = this.dataset.icon || '';
            
            // Show/hide budget field
            const budgetField = document.getElementById('category-budget-field');
            if (this.dataset.type === 'expense') {
                budgetField.style.display = 'block';
                document.getElementById('category-budget').value = this.dataset.budget || '';
            } else {
                budgetField.style.display = 'none';
                document.getElementById('category-budget').value = '';
            }
            
            // Change form action to update URL
            document.getElementById('category-form').action = "{% url 'update_category' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', categoryId);
            
            showModal('category-modal');
        });
    });
    
    // Delete category functionality
    document.querySelectorAll('.delete-category').forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.dataset.id;
            const categoryName = this.dataset.name;
            
            document.getElementById('delete-message').textContent = 
                `Are you sure you want to delete category "${categoryName}"? This action cannot be undone.`;
            
            window.confirmDelete(categoryId, "{% url 'delete_category' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', categoryId));
        });
    });
    
    // Add expense category from empty state
    document.getElementById('add-expense-category-btn')?.addEventListener('click', function() {
        document.getElementById('add-category-btn').click();
    });
    
    // Add income category from empty state
    document.getElementById('add-income-category-btn')?.addEventListener('click', function() {
        document.getElementById('add-category-btn').click();
    });
    
    // Reset form action when adding new category
    document.getElementById('add-category-btn')?.addEventListener('click', function() {
        document.getElementById('category-form').action = "{% url 'create_category' %}";
    });
</script>
{% endblock %}